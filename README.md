# server2.0

## 更新内容
2.0版主要增加了一个定时器以处理非活动连接（即规定时间内没再次活动的连接）。

## 更新说明
  书中十一章先介绍了定时器，并给出了对应代码：1.lst_timer(source),它包含一个定时器升序双向链表节点类以及双向链表类，SIGALRM信号每次触发就在其信号处理函数中执行一次tick函数，以处理链表上到期的任务；2.nonactive_conn(resource).cpp，它利用alarm函数周期性地触发SIGALRM信号，该信号的信号处理函数利用管道通知主循环执行定时器链表上的定时任务——关闭非活动的连接。接下来的工作是将上述源码结合到我们的项目中。
  lst_timer.h包含：（1）client_data类：用户信息（ip，sockfd，缓冲区）以及一个timer指针；（2）util_timer定时器节点类：前后指针、超时时间（绝对时间）、任务回调函数和指向client_data类的指针；（3）sort_timer_lst定时器双向链表：含头尾指针和双向链表的常用操作，该链表按照每个定时器的超时时间从小到大排列，这样遇到一个不超时的节点即可结束循环，因为后面的节点更不可能超时了。
  在main函数中，主要增加的部分为管道、链表的初始化，SIGALRM的产生与捕捉（往管道一端写数据），超时任务的回调函数cb_func（）的功能（删除连接）、管道另一端增添进epoll监听列表、新连接产生时的定时器初始化、超时/异常/读/写事件定时器的相关操作，具体在代码中搜索v2.0有详细注释。
  
## 定时器工作流程
![Image text](https://ftp.bmp.ovh/imgs/2021/07/3247b71a2e7a15e1.jpg)

 
